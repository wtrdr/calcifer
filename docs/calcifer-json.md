# 独自実装のJSONについて

Firestoreのデータ更新を行うにはCalciferに独自実装されているjson likeな表現を用いて行います。

一般的なjsonの値だけではなく、Firestore Document特有の `timestamp` `geopoint` `reference` の型にも対応しています。   
以下のように書いて保存することができます。

```js
[
  "foo",
  "bar",
  {
    "place": geo"-21,-65",
    "created_at": ts"2020-08-26T00:00:00.000+09:00",
    "user_ref": ref"user/1",
    "author": null,
  },
]
```

もしくは単体での利用が可能です。

```js
"foo"
```

や

```js
ts"2020-08-26T00:00:00.000+09:00"
```

など。

----------

以下に全ての型の記法を記載します。また、末尾にFieldの削除方法について記載します。

## string ("foo")

文字列。arrayやmapのvalueとしても利用可能。

### 記法

`""` で囲みます。   
`'` （シングルクォート）で囲むとエラーになります。

### 例

単一の値としてセットする場合。

```js
"foo"
```

arrayやmapの値としてセットする場合

```js
{ a: "aaa" }
[ "aaa", "bbb"]
```

## number (123)

数値。arrayやmapのvalueとしても利用可能。

### 記法

そのまま数値を書きます。   
`` ` `` や `"` で囲む必要はありません。

### 例

単一の値としてセットする場合。

```js
123
```

arrayやmapの値としてセットする場合

```js
{ a: 111 }
[ 111, 222 ]
```

## boolean (true/false)

真偽値。arrayやmapのvalueとしても利用可能。

### 記法

`true` / `false` を書きます。   
`` ` `` や `"` で囲む必要はありません。   
case sensitiveであるため `True` や `TRUE` 等はエラーになります。

### 例

単一の値としてセットする場合。

```js
true
false
```

arrayやmapの値としてセットする場合

```js
{ a: true }
[ true, false ]
```

## null (null)

null値。arrayやmapのvalueとしても利用可能。

### 記法

`null` を書きます。  
`` ` `` や `"` で囲む必要はありません。   
case sensitiveであるため `Null` や `NULL` 等はエラーになります。

### 例

単一の値としてセットする場合。

```js
null
```

arrayやmapの値としてセットする場合

```js
{ a: null }
[ null, null ]
```

## timestamp (ts"2020-05-22T22:01:51.322+09:00")

タイムスタンプ。arrayやmapのvalueとしても利用可能。

### 記法

`ts""` で囲みます。   
case sensitiveであるため `Ts""` や `TS""` 等はエラーになります。   
`ts` と `"` の間に空白を入れるとエラーになります。  
入力する値は javascript の `new Date()` の引数に渡すことができる値であれば `int` でも `string` でも書くことができます。

### 例

単一の値としてセットする場合。

```js
ts"2020-05-22T22:01:51.322+09:00"
ts"2020-05-22T22:01:51.322Z"
ts"1590184911322"
```

arrayやmapの値としてセットする場合

```js
{ a: ts"2020-05-22T22:01:51.322+09:00" }
[ ts"2020-05-22T22:01:51.322+09:00", ts"1590184911322" ]
```

## geopoint (geo"35.6580939,139.7413553")

地理位置情報。arrayやmapのvalueとしても利用可能。

### 記法

`geo""` で囲み、値を `,` で区切ります。書き方は `geo"緯度,経度"` となります。  
case sensitiveであるため `Geo""` や `GEO""` 等はエラーになります。   
`geo` と `"` の間に空白を入れるとエラーになります。  
入力する値には範囲制限があり、 `-90 <= 緯度 <= 90` 、 `-180 <= 経度 <= 180` です。

### 例

単一の値としてセットする場合。

```js
geo"35.6580939,139.7413553"
geo"-48.834,-102.3475"
```

arrayやmapの値としてセットする場合

```js
{ a: geo"35.6580939,139.7413553" }
[ geo"35.6580939,139.7413553", geo"35.6580939,139.7413553" ]
```

## reference (ref"users/2HfFxzsMFieaf835d")

他のdocumentへの参照。arrayやmapのvalueとしても利用可能。

### 記法

`ref""` で囲み、対象のdocumentへのpathを書きます。  
case sensitiveであるため `Ref""` や `REF""` 等はエラーになります。   
`ref` と `"` の間に空白を入れるとエラーになります。   

[Firebaseの公式ドキュメント](https://firebase.google.com/docs/firestore/quotas?hl=ja) にあるドキュメントIDに関する制約を受けるため、   
ドキュメントIDに `/` を使ったり（使えますが別なsubcollectionとして認識されます）、 `.` や `..` を使ったり（変更を保存できません）、 `__.*__` という文字列を使うことはできません。

### 例

単一の値としてセットする場合。

```js
ref"users/38aflkj3hb34fa3fc3"
ref"posts/8fq3fktaf8fh38vb36a11/comments/b4yjja91ddat36a"
```

arrayやmapの値としてセットする場合

```js
{ a: ref"users/111" }
[ ref"users/111", ref"users/222" ]
```


## array ([1,2,3])

配列。arrayやmapのvalueとしても利用可能。

### 記法

`[]` で囲みます。   
末尾の `,` は一つまでは無視されますが、複数個ある場合にはエラーになります（ `[1,2,3,]` => OK、 `[1,2,3,,]` => NG）。   
あらゆる値を混在して入れることができます。

### 例

```js
[ 1,2,3,"a","b","c",ref"users/111",ref"users/222" ]
```


## map ({a: "aaa", b: "bbb"})

配列。arrayやmapのvalueとしても利用可能。

### 記法

`{}` で囲みます。   
末尾の `,` は一つまでは無視されますが、複数個ある場合にはエラーになります（ `{a: "a",}` => OK、 `{a: "a",,}` => NG）。   
あらゆる値を混在して入れることができます。   
キー名は `__`（アンダースコア2つ）で囲むとエラーになります。   
キー名が一部の記号や数値を含む場合には `""` で囲まないとエラーになります。

### 例

```js
{ a: "abc", "!b": "def" }
```

# Fieldの削除について

値を空白にして保存をするとFieldごと消します。保存した後はkeyもvalueもない状態となります。値に空文字やnullを使いたい場合はそれぞれ `""` （空文字）や `null` を使ってください。

